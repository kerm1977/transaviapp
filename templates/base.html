<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APP</title>

    <!-- Importar ionicons para los iconos -->
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
    
    <!-- Incluir jQuery para las funcionalidades de Flash (opcional pero ayuda) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>


    <!-- ======================================================= -->
    <!-- ESTILOS CSS INLINE (Responsivo y Fijo en el Pie) -->
    <!-- ======================================================= -->

    <!-- PROHIBIDO TOCAR LOS TEMAS DEL NAVBAR -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif; /* Usando Inter para estética */
        }

        /* ------------------------------------------- */
        /* TEMAS (Variables Globales) */
        /* ------------------------------------------- */
        :root {
            /* Colores Base */
            --clr-main: #ff9900; /* Naranja vibrante (activo) */
            --clr-warning: #ffb700; /* Ámbar/Warning */
            --clr-bg-default: #222327;
            --nav-height: 70px;
            
            /* Tema por defecto (Dark original) */
            --clr-bg: var(--clr-bg-default); 
            --clr-nav-bg: #fff; 
            --clr-text-content: #ffffff; 
            --clr-icon-inactive: var(--clr-bg-default); /* Por defecto, los íconos inactivos toman el color de fondo del body */
        }

        .theme-light {
            --clr-bg: #f5f5f5;
            --clr-nav-bg: #ffffff;
            --clr-text-content: #222327;
            --clr-icon-inactive: #888; 
        }

        .theme-sepia {
            --clr-bg: #f8e5c8;
            --clr-nav-bg: #f9f0e2;
            --clr-text-content: #5c4033;
            --clr-icon-inactive: #5c4033;
        }

        .theme-dark {
            --clr-bg: #121212;
            --clr-nav-bg: #2d2d2d;
            --clr-text-content: #ffffff;
            /* CAMBIO: Íconos inactivos toman el color Warning */
            --clr-icon-inactive: var(--clr-warning); 
        }
        /* ------------------------------------------- */
        /* FIN TEMAS */
        /* ------------------------------------------- */

      /*PROHIBIDO TOCAR LOS ESTILOS DEL NAVBAR*/
        body {
            /* Mantenemos el body en el centro para demostración, pero la navegación se fija */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: var(--clr-bg);
            padding-bottom: var(--nav-height); /* Añade padding para que el contenido no se oculte detrás del navbar */
            transition: background 0.3s; /* Suaviza el cambio de fondo del body */
        }
        
        /* Contenedor de Flashes */
        .flash-messages {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 400px;
            z-index: 1002;
            padding-top: 50px;
        }

        .flash-message {
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            font-weight: bold;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            opacity: 0.95;
        }

        .flash-success { background-color: #4CAF50; color: white; }
        .flash-danger { background-color: #f44336; color: white; }
        .flash-warning { background-color: #ff9800; color: white; }
        .flash-info { background-color: #2196F3; color: white; }


        /* Botón de cambio de tema y usuario */
        .nav-header-info {
            position: fixed;
            top: 15px;
            right: 15px;
            z-index: 1001;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .nav-header-info span {
            color: var(--clr-text-content);
            font-size: 1.1em;
            font-weight: 600;
        }

        #theme-toggle {
            /* Posicionamiento y Estilo */
            background: none;
            border: none;
            color: var(--clr-text-content); /* Color del ícono basado en el tema */
            cursor: pointer;
            padding: 10px;
            font-size: 1.8em; /* Tamaño del ícono */
            line-height: 1;
            transition: color 0.3s, transform 0.2s;
        }
        #theme-toggle:hover {
            transform: scale(1.1); /* Efecto hover */
        }
        /* Rotación del ícono de engranaje para hacerlo interactivo */
        #theme-toggle ion-icon {
            transition: transform 0.8s ease-in-out;
        }


        /* Contenedor principal de la navegación: Fijo y 100% de ancho */
        .navigation {
            position: fixed; /* Lo fija en la pantalla */
            bottom: 0; /* Lo coloca en el pie de la página */
            
            /* CENTRADO PERFECTO: */
            left: 50%; /* Mueve el punto de inicio al 50% de la izquierda del viewport */
            transform: translateX(-50%); /* Desplaza el elemento hacia la izquierda el 50% de su propio ancho */
            /* Fin Centrado */
            
            width: 100%; /* Ocupa todo el ancho de la pantalla */
            max-width: 450px; /* Limita el ancho en pantallas grandes (desktop) */
            height: var(--nav-height);
            background: var(--clr-nav-bg);
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 0; 
            border-top-left-radius: 15px; 
            border-top-right-radius: 15px;
            box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.2);
            z-index: 1000; /* Asegura que esté por encima del contenido */
            transition: background 0.3s; /* Suaviza el cambio de fondo de la barra */
        }

        .navigation ul {
            display: flex;
            width: 100%; 
            padding: 0 10px;
        }

        .navigation ul li {
            position: relative;
            list-style: none;
            width: 20%; 
            flex-grow: 1;
            height: var(--nav-height);
            z-index: 1;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .navigation ul li a {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            width: 100%;
            text-align: center;
            font-weight: 500;
            text-decoration: none;
            height: 100%; /* Asegura que el enlace ocupe todo el LI */
        }

        .navigation ul li a .icon {
            position: relative;
            display: block;
            font-size: 1.5em;
            text-align: center;
            transition: 0.5s;
            /* CAMBIO: Íconos inactivos usan la variable de color dinámica */
            color: var(--clr-icon-inactive); 
            padding-top: 18px; 
            pointer-events: none; 
        }

        /* Transformación del ícono original (hacia arriba) */
        .navigation ul li.active a .icon {
            transform: translateY(-32px);
            /* Ocultamos completamente el ícono original */
            opacity: 0;
            padding-top: 0; 
        }

        .navigation ul li a .text {
            position: absolute;
            color: var(--clr-main);
            font-weight: 600;
            font-size: 0.75em;
            letter-spacing: 0.05em;
            transition: 0.5s;
            opacity: 0;
            transform: translateY(20px);
        }

        /* Mostrar texto con color naranja cuando está activo */
        .navigation ul li.active a .text {
            opacity: 1;
            transform: translateY(10px);
        }

        /* --- Indicador de la Magia (Color Naranja) --- */
        .indicator {
            position: absolute;
            top: -50%;
            width: 60px; 
            height: 60px;
            background: var(--clr-main);
            border-radius: 50%;
            border: 6px solid var(--clr-bg); /* Borde toma el color del fondo principal */
            transition: 0.5s;
            transform: translateX(0); /* Inicialmente centrado por JS */
            
            /* Configuración para centrar el ícono inyectado */
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden; 
        }
        
        /* Ícono inyectado que vive dentro del indicador */
        .indicator .dot-icon {
            color: #000; /* Ícono negro dentro del círculo naranja */
            font-size: 1.5em;
            /* Transición más lenta para un fade suave */
            opacity: 1; 
            transition: opacity 1.0s ease-in-out; 
            line-height: 1; 
        }
        

        /* Efecto de curva a la izquierda (corte) */
        .indicator::before {
            content: '';
            position: absolute;
            top: 50%;
            left: -22px;
            width: 20px;
            height: 20px;
            background: transparent;
            border-top-right-radius: 20px;
            box-shadow: 1px -10px 0 0 var(--clr-bg); /* Borde toma el color del fondo principal */
        }

        /* Efecto de curva a la derecha (corte) */
        .indicator::after {
            content: '';
            position: absolute;
            top: 50%;
            right: -22px;
            width: 20px;
            height: 20px;
            background: transparent;
            border-top-left-radius: 20px;
            box-shadow: -1px -10px 0 0 var(--clr-bg); /* Borde toma el color del fondo principal */
        }
        
        /* Contenido de ejemplo para ver el efecto fijo */
        .content {
            padding: 20px;
            color: var(--clr-text-content); /* El texto del contenido cambia según el tema */
            text-align: center;
            /* Asegura que el contenido no quede debajo del footer */
            min-height: calc(100vh - var(--nav-height));
            width: 100%;
            max-width: 450px;
            margin: 0 auto;
            transition: color 0.3s;
        }
        .content h1 {
            margin-bottom: 20px;
        }
        
        /* Estilos para formularios de Login/Registro */
        .auth-card {
            background: var(--clr-nav-bg);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 380px;
            margin-top: 50px;
        }

        .input-group {
            position: relative;
            margin-bottom: 25px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--clr-text-content);
            font-weight: 500;
        }

        .input-group input[type="text"],
        .input-group input[type="password"],
        .input-group input[type="email"] {
            width: 100%;
            padding: 12px 40px 12px 15px; /* Más padding a la derecha para el ícono */
            border: 1px solid #ccc;
            border-radius: 8px;
            background: var(--clr-bg);
            color: var(--clr-text-content);
            transition: border-color 0.3s;
        }
        
        .input-group input:focus {
            border-color: var(--clr-main);
            outline: none;
        }
        
        .toggle-password {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(2px); /* Ajuste fino */
            cursor: pointer;
            color: #888;
        }
        .toggle-password:hover {
            color: var(--clr-main);
        }

        .btn-primary {
            width: 100%;
            padding: 12px;
            background-color: var(--clr-main);
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: opacity 0.3s, background-color 0.3s;
            opacity: 1;
        }
        
        .btn-primary:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            opacity: 0.7;
        }

        /* Estilos para mensajes Flash */
        .alert {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
            font-weight: bold;
        }
        .alert-success { background-color: #d4edda; color: #155724; }
        .alert-danger { background-color: #f8d7da; color: #721c24; }
        .alert-info { background-color: #d1ecf1; color: #0c5460; }
        .alert-warning { background-color: #fff3cd; color: #856404; }

    </style>
</head>

<!-- El tema se establece dinámicamente -->
<body class="theme-dark"> 
    
    <!-- Contenedor para mensajes flash -->
    <div class="flash-messages">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="flash-message flash-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>


    <!-- Barra Superior: Muestra el nombre del usuario y el botón de tema -->
    <div class="nav-header-info">
        <!-- Mostrar nombre del usuario si está logueado -->
        {% if session.logged_in %}
            <span>Hola, {{ session.full_name.split(' ')[0] }}</span>
            <a href="{{ url_for('auth.logout') }}" title="Cerrar Sesión" style="color: var(--clr-warning); font-size: 1.5em;">
                <ion-icon name="log-out-outline"></ion-icon>
            </a>
        {% else %}
            <!-- Si no está logueado, se deja vacío o se pone un placeholder, pero el botón de tema permanece -->
        {% endif %}

        <!-- Botón de cambio de tema: AQUI NO SE PUEDE MOVER NI MODIFICAR ABSOLUTAMENTE NADA DE EL  -->
        <button id="theme-toggle" title="Cambiar Tema">
            <ion-icon name="color-palette-outline"></ion-icon>
        </button>
    </div>

    <!-- Contenido de la vista (Index, Login, Register, etc.) -->
    <div class="content">
        {% block content %}{% endblock %}
    </div>


    <!-- ======================================================= -->
    <!-- ESTRUCTURA HTML - NAVBAR INFERIOR (SIEMPRE VISIBLE) -->
    <!-- ======================================================= -->
    <div class="navigation">
        <ul>
            <!-- Elementos de la lista -->
            <li class="list active" data-icon-name="home-outline">
                <a href="{{ url_for('main.index') }}">
                    <span class="icon">
                        <ion-icon name="home-outline"></ion-icon>
                    </span>
                    <span class="text">Inicio</span>
                </a>
            </li>
            
            <!-- ENLACE DINÁMICO DE PERFIL/LOGIN -->
            <li class="list" data-icon-name="person-outline">
                <a href="{{ url_for('main.index') if session.logged_in else url_for('auth.login') }}">
                    <span class="icon">
                        <ion-icon name="person-outline"></ion-icon>
                    </span>
                    <span class="text">
                        {% if session.logged_in %}Perfil{% else %}Acceder{% endif %}
                    </span>
                </a>
            </li>
            
            <!-- Estos enlaces solo funcionan si se está logueado -->
            <li class="list" data-icon-name="chatbubble-outline">
                <a href="{{ url_for('main.index') if session.logged_in else url_for('auth.login') }}" onclick="handleNavClick(event)">
                    <span class="icon">
                        <ion-icon name="chatbubble-outline"></ion-icon>
                    </span>
                    <span class="text">Mensajes</span>
                </a>
            </li>
            <li class="list" data-icon-name="camera-outline">
                <a href="{{ url_for('main.index') if session.logged_in else url_for('auth.login') }}" onclick="handleNavClick(event)">
                    <span class="icon">
                        <ion-icon name="camera-outline"></ion-icon>
                    </span>
                    <span class="text">Fotos</span>
                </a>
            </li>
            <li class="list" data-icon-name="settings-outline">
                <a href="{{ url_for('main.index') if session.logged_in else url_for('auth.login') }}" onclick="handleNavClick(event)">
                    <span class="icon">
                        <ion-icon name="settings-outline"></ion-icon>
                    </span>
                    <span class="text">Ajustes</span>
                </a>
            </li>

            <!-- INDICADOR: Ahora solo contendrá el ícono activo inyectado por JS -->
            <div class="indicator">
                <!-- Ícono de reemplazo. Se inyecta aquí con JS -->
            </div>
        </ul>
    </div>

    {% block scripts %}{% endblock %}

    <!-- ======================================================= -->
    <!-- COMPORTAMIENTO JAVASCRIPT (Responsivo, Centrado y Temas) -->
    <!-- ======================================================= -->
    <script>
        const list = document.querySelectorAll('.list');
        const indicator = document.querySelector('.indicator');
        const body = document.body;
        const themeToggleButton = document.getElementById('theme-toggle');

        // Función para manejar el clic en enlaces protegidos (si no está logueado)
        function handleNavClick(event) {
            const loggedIn = "{{ session.logged_in | default('False') }}" === 'True';
            if (!loggedIn) {
                // Si no está logueado, redirigir a login y evitar el cambio de indicador.
                if (event.target.closest('a').href.endsWith('/auth/login')) {
                    // Si el enlace ya apunta a login, simplemente se ignora y se permite la navegación
                    return; 
                }
                // Si intenta ir a una ruta protegida, se redirige.
                window.location.href = '{{ url_for("auth.login") }}';
                event.preventDefault();
            }
        }


        // -------------------------------------------
        // Lógica de Temas
        // -------------------------------------------
        const themes = ['theme-dark', 'theme-light', 'theme-sepia'];
        let currentThemeIndex = 0;
        
        function getPathname() {
            // Retorna la ruta base (ej: /auth/login, /index) sin el origen
            return window.location.pathname.replace(/^\/|\/$/g, '');
        }

        // Función para cambiar el tema
        function toggleTheme() {
            body.classList.remove(themes[currentThemeIndex]);
            currentThemeIndex = (currentThemeIndex + 1) % themes.length;
            const newTheme = themes[currentThemeIndex];
            body.classList.add(newTheme);

            const iconElement = themeToggleButton.querySelector('ion-icon');
            iconElement.style.transform = `rotate(${currentThemeIndex * 120}deg)`; 

            const activeItem = document.querySelector('.list.active');
            if (activeItem) {
                setTimeout(() => moveIndicator(activeItem), 50); 
            }
        }
        
        themeToggleButton.addEventListener('click', toggleTheme);
        body.classList.add('theme-dark'); // Tema inicial

        // -------------------------------------------
        // Lógica de Navbar y Movimiento
        // -------------------------------------------

        // Función para inyectar y centrar el ícono dentro del indicador
        function updateIndicatorContent(element) {
            const iconName = element.getAttribute('data-icon-name');
            const iconHtml = `<span class="dot-icon"><ion-icon name="${iconName}"></ion-icon></span>`;
            
            indicator.innerHTML = iconHtml;
            
            const dotIcon = indicator.querySelector('.dot-icon');
            setTimeout(() => {
                if (dotIcon) {
                    dotIcon.style.opacity = '1';
                }
            }, 500); 
        }

        // Función para mover el indicador
        function moveIndicator(element) {
            // Calcular offset
            const listWidth = element.offsetWidth;
            const indicatorWidth = indicator.offsetWidth;
            const offset = element.offsetLeft + (listWidth / 2) - (indicatorWidth / 2);

            // Ocultar ícono anterior
            const currentDotIcon = indicator.querySelector('.dot-icon');
            if (currentDotIcon) {
                currentDotIcon.style.opacity = '0';
            }

            // Aplicar la transformación
            indicator.style.transition = '0.5s';
            indicator.style.transform = `translateX(${offset}px)`;
            
            // Actualiza el contenido del indicador
            updateIndicatorContent(element);
        }

        // Función para marcar el enlace activo basado en la URL
        function highlightActiveLink() {
            const path = getPathname();
            let activeItem = null;

            // Limpiar la clase 'active' de todos
            list.forEach((item) => {
                item.classList.remove('active');
            });
            
            // Identificar qué elemento debe estar activo
            if (path.includes('index') || path === '') {
                // Si es inicio o la raíz, activa el Home
                activeItem = document.querySelector('[data-icon-name="home-outline"]').closest('li');
            } else if (path.includes('login') || path.includes('register')) {
                // Si es login o register, activa el Perfil/Acceder
                activeItem = document.querySelector('[data-icon-name="person-outline"]').closest('li');
            } else {
                 // Si es cualquier otra cosa (mensajes, fotos, etc.), por defecto Home
                 activeItem = document.querySelector('[data-icon-name="home-outline"]').closest('li');
            }

            if (activeItem) {
                activeItem.classList.add('active');
                // Inicializa el indicador en la posición correcta
                moveIndicator(activeItem);
            }
        }

        // Asignar el evento de click (solo para actualizar el indicador en SPA-like)
        list.forEach((item) => {
            // Usamos un listener que solo actualiza el estado activo y mueve el indicador
            item.addEventListener('click', (e) => {
                 // Permitimos la navegación nativa (no hacemos e.preventDefault())
                 // Solo actualizamos la clase activa y la posición del indicador inmediatamente
                 
                 list.forEach((i) => i.classList.remove('active'));
                 item.classList.add('active');
                 moveIndicator(item);
            });
        });
        
        // Inicialización y Responsividad
        window.addEventListener('load', highlightActiveLink);
        window.addEventListener('resize', () => {
             const activeItem = document.querySelector('.list.active');
             if (activeItem) {
                moveIndicator(activeItem);
             }
        });
        
        // Ocultar mensajes flash después de 5 segundos
        $(document).ready(function() {
            window.setTimeout(function() {
                $(".flash-message").fadeTo(500, 0).slideUp(500, function(){
                    $(this).remove(); 
                });
            }, 5000); // 5 segundos
        });

    </script>
</body>
</html>
