{% extends "base.html" %}

{% block title %}Registro de Usuario{% endblock %}

{% block head_styles %}
<style>
    /* Estilos de scroll ocultos ahora están en base.html */
    
    /* Estilos para que el formulario sea el contenedor principal */
    .register-form-wrapper {
        /* Centrado en la página */
        max-width: 450px;
        width: 90%;
        margin: 40px auto; 
        padding: 0; 
        background: transparent;
        box-shadow: none;
        border-radius: 0;
        
        /* Aseguramos que haya suficiente padding al final para no chocar con la navbar */
        padding-bottom: 120px; 
    }

    /* ELIMINACIÓN FINAL DEL EFECTO CARD EN EL FORMULARIO */
    .register-form-wrapper form {
         background: none !important; /* Eliminamos el fondo para la transparencia total */
         padding: 0 !important; /* Eliminamos el padding */
         border-radius: 0 !important; /* Eliminamos el borde */
         box-shadow: none !important; /* Eliminamos la sombra */
    }
    
    /* Mantener los estilos de input, botones y validación */
    .input-group {
        /* Se reduce el margen inferior, ya que el validador vuelve al interior del input */
        margin-bottom: 20px; 
        position: relative;
    }

    .input-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
        color: var(--clr-text-content); 
    }

    /* ------------------------------------------- */
    /* MODIFICACIÓN CLAVE: Se añade padding a la derecha para dar espacio al icono */
    /* ------------------------------------------- */
    .input-group input[type="text"],
    .input-group input[type="password"],
    .input-group input[type="email"],
    .input-group input[type="tel"] {
        width: 100%;
        /* Aumento del padding derecho a 40px para que el texto no oculte el ícono */
        padding: 12px 40px 12px 10px; 
        border: 1px solid #ccc;
        border-radius: 6px;
        background-color: var(--clr-bg); 
        color: var(--clr-text-content);
        transition: border-color 0.3s;
    }

    .input-group input:focus {
        border-color: var(--clr-main);
        outline: none;
    }

    /* Iconos de validación - REPOSICIONAMIENTO DENTRO DEL INPUT */
    .validation-icon {
        /* Posicionamiento dentro del input: a la derecha, centrado verticalmente */
        position: absolute;
        right: 10px; 
        top: 50%; /* Centra verticalmente */
        transform: translateY(20%); /* Ajuste fino para la posición real del texto */
        
        font-size: 1.2em; /* Tamaño estándar */
        pointer-events: none;
        z-index: 5;
        
        /* Eliminamos estilos de "flotante" */
        background: transparent; 
        padding: 0;
        box-shadow: none;
    }

    /* Ajuste para el icono de contraseña (Toggle Password), que es clickable */
    .toggle-password {
        position: absolute;
        right: 10px;
        top: 60%;
        transform: translateY(-50%);
        cursor: pointer;
        color: #888;
        z-index: 5;
    }
    .toggle-password:hover {
        color: var(--clr-main);
    }
    
    .btn-primary {
        width: 100%;
        padding: 12px;
        border: none;
        border-radius: 6px;
        background-color: var(--clr-main);
        color: #000;
        font-size: 1.1em;
        font-weight: bold;
        cursor: pointer;
        transition: background-color 0.3s, transform 0.1s;
    }

    .btn-primary:hover:not(:disabled) {
        background-color: var(--clr-warning);
    }

    .btn-primary:disabled {
        background-color: #ccc; 
        cursor: not-allowed;
    }

</style>
{% endblock %}

{% block content %}
<!-- Se reemplaza auth-container por un div simple que actúa como wrapper del formulario -->
<div class="register-form-wrapper">
    <h1 style="text-align: center; color: var(--clr-main); margin-bottom: 25px;">Crear Cuenta</h1>
    
    <form method="POST" action="{{ url_for('auth.register') }}">
        
        <!-- Nombre: Solo letras. Se aplica Title Case automáticamente. -->
        <div class="input-group">
            <label for="nombre">Nombre:</label>
            <input type="text" id="nombre" name="nombre" value="{{ form_data.nombre or '' }}" 
                   pattern="[a-zA-ZáéíóúÁÉÍÓÚñÑ]+" 
                   oninput="validateName(this)" required>
        </div>

        <!-- Primer Apellido: Solo letras. Se aplica Title Case automáticamente. -->
        <div class="input-group">
            <label for="apellido1">Primer Apellido:</label>
            <input type="text" id="apellido1" name="apellido1" value="{{ form_data.apellido1 or '' }}" 
                   pattern="[a-zA-ZáéíóúÁÉÍÓÚñÑ]+" 
                   oninput="validateName(this)" required>
        </div>

        <!-- Segundo Apellido (Opcional): Solo letras. Se aplica Title Case automáticamente. -->
        <div class="input-group">
            <label for="apellido2">Segundo Apellido (Opcional):</label>
            <input type="text" id="apellido2" name="apellido2" value="{{ form_data.apellido2 or '' }}" 
                   pattern="[a-zA-ZáéíóúÁÉÍÓÚñÑ]*" 
                   oninput="validateName(this, false)">
        </div>

        <!-- Teléfono: Solo 8 dígitos. (Se mantiene el estilo sin icono para consistencia con la versión anterior) -->
        <div class="input-group">
            <label for="telefono">Teléfono (8 dígitos):</label>
            <input type="text" id="telefono" name="telefono" value="{{ form_data.telefono or '' }}" 
                   pattern="[0-9]{8}" 
                   oninput="validatePhone(this)" required>
        </div>

        <!-- Email: Validación básica de formato. (Se mantiene el estilo sin icono para consistencia con la versión anterior) -->
        <div class="input-group">
            <label for="email">Email:</label>
            <input type="email" id="email" name="email" value="{{ form_data.email or '' }}" 
                   oninput="validateEmail(this)" required>
        </div>

        <!-- Nombre de Usuario: Longitud 5-15, alfanumérico. (CON ICONO DE VALIDACIÓN DENTRO DEL INPUT) -->
        <div class="input-group">
            <label for="usuario">Nombre de Usuario (5-15 caracteres):</label>
            <!-- El icono de validación se coloca aquí, inmediatamente después del input -->
            <input type="text" id="usuario" name="usuario" value="{{ form_data.usuario or '' }}" 
                   pattern="[a-zA-Z0-9]{5,15}" 
                   oninput="validateUsername(this)" required>
            <span class="validation-icon" id="icon-usuario"></span>
        </div>
        
        <!-- Contraseña: Con eye-off para mostrar/ocultar. -->
        <div class="input-group">
            <label for="password">Contraseña (Mín. 8 caracteres):</label>
            <input type="password" id="password" name="password" 
                   minlength="8" 
                   oninput="checkPasswords()" required>
            <span class="toggle-password" onclick="togglePasswordVisibility('password')">
                <ion-icon name="eye-off-outline" id="icon-password-toggle"></ion-icon>
            </span>
        </div>

        <!-- Confirmar Contraseña: -->
        <div class="input-group">
            <label for="password_confirm">Confirmar Contraseña:</label>
            <input type="password" id="password_confirm" name="password_confirm" 
                   oninput="checkPasswords()" required>
            <span class="toggle-password" onclick="togglePasswordVisibility('password_confirm')">
                <ion-icon name="eye-off-outline" id="icon-password_confirm-toggle"></ion-icon>
            </span>
            <!-- Feedback de Contraseñas (Texto simple) -->
            <small id="password-feedback" style="margin-top: 5px; font-size: 0.9em; display: none;">Las contraseñas no coinciden.</small>
        </div>


        <button type="submit" class="btn-primary" id="register-button" disabled>Registrarme</button>
        
    </form>
    
    <p style="text-align: center; margin-top: 20px; font-size: 0.9em;">
        ¿Ya tienes una cuenta? 
        <a href="{{ url_for('auth.login') }}" style="color: var(--clr-main); text-decoration: none; font-weight: bold;">Inicia sesión aquí</a>
    </p>

</div>
{% endblock %}

{% block scripts %}
<script>
    // Estado global de validación
    let validationState = {
        nombre: true,
        apellido1: true,
        telefono: false,
        email: false,
        usuario: false,
        passwords: false
    };
    
    // El email es un caso especial por la asincronicidad, inicializarlo aparte.
    const emailInput = document.getElementById('email');
    const passwordFeedback = document.getElementById('password-feedback');

    // Función para actualizar el estado del botón
    function updateButtonState() {
        const button = document.getElementById('register-button');
        const isValid = Object.values(validationState).every(Boolean);
        button.disabled = !isValid;
    }

    // Función para mostrar/ocultar la contraseña
    function togglePasswordVisibility(fieldId) {
        const field = document.getElementById(fieldId);
        // Aseguramos que solo afecte al ícono de toggle, no al de validación
        const icon = document.getElementById(`icon-${fieldId}-toggle`); 
        if (field.type === "password") {
            field.type = "text";
            icon.name = "eye-outline";
        } else {
            field.type = "password";
            icon.name = "eye-off-outline";
        }
    }

    // 1. Validación de Nombre/Apellido (Title Case)
    function validateName(input, isRequired = true) {
        let value = input.value.trim();
        // Aplicar Title Case: solo si no está vacío
        if (value.length > 0) {
            value = value.charAt(0).toUpperCase() + value.slice(1).toLowerCase();
            // Esto solo funciona si solo hay un nombre/apellido
            input.value = value;
        }

        // Validación de formato: solo letras
        const regex = /^[a-zA-ZáéíóúÁÉÍÓÚñÑ]*$/;
        const isValid = isRequired ? (regex.test(value) && value.length > 0) : regex.test(value);
        
        // No hay iconos de validación para Nombre/Apellido, solo el estado interno.
        validationState[input.id] = isValid || !isRequired; // Si no es requerido, es válido si está vacío
        updateButtonState();
    }
    
    // 2. Validación de Teléfono (SIN ICONO)
    function validatePhone(input) {
        const value = input.value.trim();
        // ELIMINADO: const iconElement = document.getElementById('icon-telefono');
        
        // Solo 8 dígitos, sin caracteres
        const regex = /^[0-9]{8}$/;
        const isValid = regex.test(value);
        
        // Restricción: solo permitir 8 números
        input.value = input.value.replace(/[^0-9]/g, '').slice(0, 8);
        
        validationState.telefono = isValid;
        updateButtonState();
    }
    
    // 3. Validación de Email (SIN ICONO)
    function validateEmail(input) {
        const value = input.value.trim();
        // ELIMINADO: const iconElement = document.getElementById('icon-email');
        
        // Expresión regular de email básica
        const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        const isValid = regex.test(value);
        
        validationState.email = isValid;
        updateButtonState();
    }

    // 4. Validación de Usuario (CON ICONO)
    function validateUsername(input) {
        const value = input.value.trim();
        const iconElement = document.getElementById('icon-usuario');
        
        // 5 a 15 caracteres alfanuméricos
        const regex = /^[a-zA-Z0-9]{5,15}$/;
        const isLengthValid = regex.test(value);

        // Se mantiene el código para actualizar el icono de usuario
        if (isLengthValid) {
            iconElement.innerHTML = '<ion-icon name="checkmark-circle-outline"></ion-icon>';
            iconElement.style.color = '#4CAF50'; // Verde
        } else {
            iconElement.innerHTML = '<ion-icon name="close-circle-outline"></ion-icon>';
            iconElement.style.color = '#f44336'; // Rojo
        }
        
        // Ocultar el icono si el campo está vacío
        if (value.length === 0) {
            iconElement.innerHTML = '';
        }

        validationState.usuario = isLengthValid;
        updateButtonState();
    }

    // 5. Validación de Contraseñas
    function checkPasswords() {
        const password = document.getElementById('password').value;
        const passwordConfirm = document.getElementById('password_confirm').value;
        
        const passwordsMatch = password === passwordConfirm && password.length >= 8;
        
        if (password.length > 0 && passwordConfirm.length > 0) {
             if (!passwordsMatch) {
                passwordFeedback.style.display = 'block';
                passwordFeedback.style.color = '#f44336'; // Rojo
                passwordFeedback.textContent = 'Las contraseñas no coinciden o son muy cortas.';
            } else {
                passwordFeedback.style.display = 'block';
                passwordFeedback.style.color = '#4CAF50'; // Verde
                passwordFeedback.textContent = 'Las contraseñas coinciden.';
            }
        } else {
            passwordFeedback.style.display = 'none';
        }


        validationState.passwords = passwordsMatch;
        updateButtonState();
    }
    
    // Inicializar estado de validación al cargar la página
    document.addEventListener('DOMContentLoaded', () => {
        // Ejecutar validaciones iniciales si hay datos precargados (después de un error de Flask)
        validateName(document.getElementById('nombre'));
        validateName(document.getElementById('apellido1'));
        validatePhone(document.getElementById('telefono'));
        validateUsername(document.getElementById('usuario'));
        checkPasswords();
        
        // Inicializa validación de email si tiene valor
        emailInput.dispatchEvent(new Event('input'));
        
        updateButtonState();
    });
</script>
{% endblock %}
